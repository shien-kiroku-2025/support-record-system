<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='180' height='180'><rect fill='%232c5aa0' width='180' height='180'/><text x='90' y='100' text-anchor='middle' fill='white' font-size='80' font-family='sans-serif'>ğŸ“‹</text></svg>">
  <title>æ”¯æ´è¨˜éŒ²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ãƒ­ã‚°ã‚¤ãƒ³</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: rgba(0,0,0,0.1);
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'ãƒ¡ã‚¤ãƒªã‚ª', 'Meiryo', sans-serif;
      padding: 10px; 
      background: #f5f5f5;
      margin: 0;
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }
    
    .login-container {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
    }
    
    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .login-header h1 {
      color: #2c5aa0;
      margin: 0 0 10px 0;
      font-size: 1.8em;
    }
    
    .login-header p {
      color: #666;
      margin: 0;
      font-size: 0.9em;
    }
    
    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-group input {
      padding: 14px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: border-color 0.3s;
      min-height: 48px;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #2c5aa0;
    }
    
    .btn-login {
      background: #2c5aa0;
      color: white;
      padding: 16px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      min-height: 56px;
    }
    
    .btn-login:hover {
      background: #1e3f7a;
    }
    
    .btn-login:active {
      transform: scale(0.98);
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid #c62828;
      font-size: 14px;
      display: none;
    }
    
    .error-message.show {
      display: block;
    }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªç”»é¢ */
    .app-screen {
      display: none;
    }
    
    .app-screen.active {
      display: block;
    }
    
    h1 { 
      color: #2c5aa0; 
      text-align: center; 
      margin: 10px 0 20px 0;
      font-size: 1.5em;
    }
    
    .user-info {
      text-align: center;
      margin-bottom: 15px;
      padding: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .user-info span {
      color: #2c5aa0;
      font-weight: bold;
      margin-right: 15px;
    }
    
    .btn-logout {
      background: #757575;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }
    
    .btn-logout:hover {
      background: #616161;
    }
    
    .controls { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 8px; 
      margin-bottom: 15px;
      justify-content: center;
    }
    
    .btn { 
      padding: 12px 20px; 
      cursor: pointer; 
      border: none; 
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.2s;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
      min-height: 48px;
    }
    .btn:active { 
      transform: scale(0.95); 
      opacity: 0.8;
    }
    .btn-add { background: #4CAF50; color: white; }
    .btn-save { background: #FF9800; color: white; }
    .btn-export { background: #2196F3; color: white; }
    .btn-clear { background: #f44336; color: white; }
    .btn-cancel { background: #9E9E9E; color: white; }
    .btn-master { background: #9C27B0; color: white; }
    .btn-sync { background: #00BCD4; color: white; }
    .btn-remove { background: #f44336; color: white; font-size: 14px; padding: 8px 16px; min-height: 40px; }
    .btn-voice { 
      background: #FF5722; 
      color: white;
      position: relative;
      min-width: 48px;
      min-height: 48px;
      padding: 10px;
      border-radius: 6px;
    }
    .btn-voice.recording {
      background: #f44336;
      animation: pulse 1.5s infinite;
    }
    .btn-toggle {
      background: #673AB7;
      color: white;
      padding: 16px 24px;
      font-size: 18px;
      min-height: 56px;
      width: 100%;
      max-width: 400px;
      margin: 0 auto 20px;
      display: block;
    }
    .btn-toggle.active {
      background: #FF5722;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 20px auto;
      padding: 20px;
      border-radius: 12px;
      width: 95%;
      max-width: 800px;
      max-height: 85vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #2c5aa0;
    }
    
    .modal-header h2 {
      color: #2c5aa0;
      margin: 0;
      font-size: 1.3em;
    }
    
    .close {
      color: #aaa;
      font-size: 32px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
      padding: 0 10px;
      min-width: 48px;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
    }
    
    .close:hover, .close:active {
      color: #000;
    }
    
    .master-section {
      margin-bottom: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    
    .master-section h3 {
      color: #2c5aa0;
      margin-top: 0;
      font-size: 1.1em;
    }
    
    .master-input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .master-input-group input,
    .master-input-group select {
      padding: 14px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      min-height: 48px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .master-input-group input:focus,
    .master-input-group select:focus {
      outline: none;
      border-color: #2c5aa0;
    }
    
    .master-input-group button {
      min-height: 48px;
    }
    
    .master-list {
      margin-top: 15px;
    }
    
    .master-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .master-item-info {
      flex: 1;
      min-width: 0;
    }
    
    .master-item-name {
      font-weight: bold;
      color: #333;
      word-break: break-word;
      font-size: 16px;
    }
    
    .master-item-service, .master-item-mapping {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    
    .btn-delete {
      padding: 10px 16px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      min-width: 70px;
      min-height: 44px;
      margin-left: 10px;
      flex-shrink: 0;
      font-weight: bold;
      touch-action: manipulation;
    }
    
    .btn-delete:active {
      background: #d32f2f;
      transform: scale(0.95);
    }
    
    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .input-section {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .input-section h3 { 
      margin: 0 0 15px 0; 
      color: #2c5aa0; 
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 1.2em;
    }
    
    .input-row {
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      position: relative;
      margin-bottom: 15px;
    }
    
    .input-row.active {
      border: 2px solid #4CAF50;
      background: #f1f8f4;
    }
    
    /* åˆ‡ã‚Šæ›¿ãˆè¡¨ç¤ºåˆ¶å¾¡ */
    .support-input-area,
    .vital-input-area {
      display: none;
    }
    
    .support-input-area.active,
    .vital-input-area.active {
      display: block;
    }
    
    /* 1æ®µç›®ï¼šåŸºæœ¬æƒ…å ± */
    .basic-info-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #ddd;
    }
    
    /* 2æ®µç›®ï¼šæ”¯æ´å†…å®¹ã‚¨ãƒªã‚¢ */
    .support-content-section {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    /* æ”¯æ´å†…å®¹å…¥åŠ›ã‚’å¸¸ã«æ¨ªä¸¦ã³ã«å¤‰æ›´ */
    .support-content-row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 15px;
      padding: 14px;
      background: #fafafa;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      position: relative;
    }
    
    .support-content-row:last-child {
      margin-bottom: 0;
    }
    
    .support-label {
      font-weight: bold;
      color: #2c5aa0;
      margin-bottom: 10px;
      font-size: 1.1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .support-number {
      background: #2c5aa0;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.9em;
      display: inline-block;
    }
    
    .support-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 10px;
      grid-column: 1 / -1;
    }
    
    /* ãƒã‚¤ã‚¿ãƒ«å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .vital-section {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .vital-entry {
      padding: 14px;
      background: #fafafa;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      margin-bottom: 15px;
      position: relative;
    }
    
    .vital-entry:last-child {
      margin-bottom: 0;
    }
    
    .vital-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .vital-number {
      background: #f44336;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.9em;
      font-weight: bold;
    }
    
    .vital-time {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .vital-time input {
      padding: 10px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      min-height: 44px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .vital-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 12px;
    }
    
    @media screen and (min-width: 600px) {
      .vital-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    .vital-field {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
    }
    
    .vital-field label {
      font-weight: bold;
      color: #555;
      margin-bottom: 8px;
      display: block;
      font-size: 15px;
    }
    
    .vital-field input {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      min-height: 48px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .vital-field input:focus {
      outline: none;
      border-color: #2c5aa0;
    }
    
    .input-field {
      display: flex;
      flex-direction: column;
    }
    
    .input-field label {
      font-size: 13px;
      font-weight: bold;
      color: #555;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    
    .input-field label .required {
      color: red;
      font-size: 16px;
    }
    
    .input-field input,
    .input-field select,
    .input-field textarea {
      padding: 10px;
      font-size: 14px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-family: -apple-system, BlinkMacSystemFont, 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
      width: 100%;
      min-height: 40px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .input-field input:focus,
    .input-field select:focus,
    .input-field textarea:focus {
      outline: none;
      border-color: #2c5aa0;
    }
    
    .input-field select {
      background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8"><path fill="%23333" d="M0 0l6 8 6-8z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 8px center;
      padding-right: 30px;
    }
    
    .input-field textarea {
      resize: vertical;
      min-height: 80px;
      line-height: 1.4;
    }
    
    .input-field-time {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 4px;
    }
    
    .input-field-time span {
      text-align: center;
      font-weight: bold;
      font-size: 12px;
    }
    
    .input-field-time input {
      padding: 8px;
      font-size: 13px;
      min-height: 36px;
    }
    
    .row-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .row-actions button {
      padding: 14px 24px;
      font-size: 16px;
      min-height: 48px;
      flex: 1;
      min-width: 120px;
    }
    
    /* ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .sync-section {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .sync-section h3 {
      color: #2c5aa0;
      margin-top: 0;
      font-size: 1.1em;
    }
    
    .sync-info {
      padding: 12px;
      background: #e3f2fd;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .sync-status {
      padding: 10px;
      background: #fff;
      border-left: 4px solid #4CAF50;
      margin-top: 10px;
      font-size: 14px;
      border-radius: 4px;
    }
    
    .sync-status.error {
      border-left-color: #f44336;
      background: #ffebee;
    }
    
    /* ãƒ•ã‚£ãƒ«ã‚¿ã‚¨ãƒªã‚¢ */
    .filter-box { 
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .filter-box h3 { 
      margin-top: 0; 
      color: #2c5aa0;
      font-size: 1.1em;
    }
    .filter-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .filter-row input, .filter-row select { 
      padding: 14px; 
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      min-height: 48px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .filter-row select {
      background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8"><path fill="%23333" d="M0 0l6 8 6-8z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    .table-container {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      background: white;
      min-width: 600px;
    }
    th, td { 
      border: 1px solid #e0e0e0; 
      padding: 12px 10px; 
      text-align: left;
      font-size: 14px;
    }
    th { 
      background: #2c5aa0; 
      color: white; 
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    tr:nth-child(even) { background: #f9f9f9; }
    tr:hover { background: #e3f2fd; }
    
    .service-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      color: white;
      white-space: nowrap;
    }
    .badge-ç”Ÿæ´»ä»‹è­· { background: #4CAF50; }
    .badge-å°±åŠ´ç¶™ç¶šAå‹ { background: #2196F3; }
    .badge-å°±åŠ´ç¶™ç¶šBå‹ { background: #FF9800; }
    .badge-å…¥æ‰€æ”¯æ´ { background: #9C27B0; }
    .badge-å±…å®…ä»‹è­· { background: #00BCD4; }
    .badge-ãã®ä»– { background: #607D8B; }
    
    /* éŸ³å£°å…¥åŠ›ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .voice-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 40px;
      border-radius: 20px;
      z-index: 2000;
      display: none;
      text-align: center;
      min-width: 280px;
    }
    
    .voice-indicator.active {
      display: block;
    }
    
    .voice-wave {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      border: 4px solid #f44336;
      border-radius: 50%;
      animation: wave 1.5s infinite;
    }
    
    @keyframes wave {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.5; }
    }
    
    .condition-mapping-list {
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .condition-chip {
      display: inline-block;
      background: #e3f2fd;
      color: #1976d2;
      padding: 5px 10px;
      margin: 3px;
      border-radius: 12px;
      font-size: 13px;
    }

    /* PCç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®æœ€é©åŒ– */
    @media screen and (min-width: 768px) {
      body { padding: 20px; font-size: 14px; }
      h1 { font-size: 2em; }
      
      .basic-info-row {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .support-content-row {
        grid-template-columns: 2fr 2fr 1.5fr 1.5fr 1.5fr 3fr 2fr;
        gap: 12px;
      }
      
      .support-actions {
        grid-column: 1 / -1;
      }
      
      .master-input-group {
        flex-direction: row;
      }
      
      .filter-row {
        flex-direction: row;
        flex-wrap: wrap;
      }
      
      .filter-row input, 
      .filter-row select {
        flex: 1;
        min-width: 150px;
      }
      
      .row-actions button {
        flex: 0;
        min-width: 140px;
      }
      
      .btn {
        font-size: 14px;
        padding: 10px 20px;
        min-height: 44px;
      }
      
      .input-field input,
      .input-field select,
      .input-field textarea {
        font-size: 14px;
        padding: 12px;
        min-height: 44px;
      }
      
      .input-field label {
        font-size: 14px;
      }
      
      .vital-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ */
    @media screen and (min-width: 600px) and (max-width: 767px) {
      .basic-info-row {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .support-content-row {
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
      }
      
      .support-actions {
        grid-column: 1 / -1;
      }
    }
    
    /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç”¨ */
    @media screen and (max-width: 599px) {
      .support-content-row {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      
      .input-field label {
        font-size: 12px;
      }
      
      .input-field input,
      .input-field select,
      .input-field textarea {
        font-size: 13px;
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <div id="loginScreen" class="login-screen">
    <div class="login-container">
      <div class="login-header">
        <h1>ğŸ“‹ æ”¯æ´è¨˜éŒ²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
      </div>
      
      <div id="errorMessage" class="error-message"></div>
      
      <form class="login-form" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="loginId">ãƒ­ã‚°ã‚¤ãƒ³ID</label>
          <input type="text" id="loginId" required autocomplete="username" placeholder="IDã‚’å…¥åŠ›">
        </div>
        
        <div class="form-group">
          <label for="loginPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" id="loginPassword" required autocomplete="current-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        </div>
        
        <button type="submit" class="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </form>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”»é¢ -->
  <div id="appScreen" class="app-screen">
    <h1>ğŸ“‹ æ”¯æ´è¨˜éŒ²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
    
    <div class="user-info">
      <span>ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <span id="currentUser"></span></span>
      <button class="btn-logout" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div class="controls">
      <button class="btn btn-master" onclick="openMasterModal()">âš™ï¸ ãƒã‚¹ã‚¿ãƒ¼</button>
      <button class="btn btn-sync" onclick="openSyncModal()">â˜ï¸ åŒæœŸ</button>
      <button class="btn btn-export" onclick="exportExcel()">ğŸ“¤ Excel</button>
      <button class="btn btn-clear" onclick="clearAll()">ğŸ—‘ï¸ å‰Šé™¤</button>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿åŒæœŸè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="syncModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>â˜ï¸ ãƒ‡ãƒ¼ã‚¿åŒæœŸè¨­å®š</h2>
          <span class="close" onclick="closeSyncModal()">&times;</span>
        </div>
        
        <div class="sync-section">
          <h3>ğŸ“± è¤‡æ•°ç«¯æœ«ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰</h3>
          <div class="sync-info">
            <strong>ã€å…±æœ‰æ–¹æ³•ã€‘</strong><br>
            1. Google Sheetsã§æ–°è¦ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ<br>
            2. ã€Œæ‹¡å¼µæ©Ÿèƒ½ã€â†’ã€ŒApps Scriptã€ã‚’é–‹ã<br>
            3. æä¾›ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆ<br>
            4. ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’å–å¾—<br>
            5. ä¸‹è¨˜ã«URLã‚’å…¥åŠ›ã—ã¦ä¿å­˜
          </div>
          
          <div class="master-input-group">
            <input type="text" id="sheetsApiUrl" placeholder="Google Apps Script ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURL">
            <button class="btn btn-save" onclick="saveSyncSettings()">ğŸ’¾ ä¿å­˜</button>
          </div>
          
          <div class="master-input-group" style="margin-top: 20px;">
            <button class="btn btn-sync" onclick="syncToCloud()">â¬†ï¸ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            <button class="btn btn-add" onclick="syncFromCloud()">â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
          </div>
          
          <div id="syncStatus" class="sync-status" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="masterModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>âš™ï¸ ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†</h2>
          <span class="close" onclick="closeMasterModal()">&times;</span>
        </div>
        
        <!-- åˆ©ç”¨è€…ç™»éŒ² -->
        <div class="master-section">
          <h3>ğŸ‘¤ åˆ©ç”¨è€…ç™»éŒ²</h3>
          <div class="master-input-group">
            <input type="text" id="newUserName" placeholder="åˆ©ç”¨è€…åã‚’å…¥åŠ›">
            <select id="newUserService">
              <option value="">ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã‚’é¸æŠ</option>
            </select>
            <button class="btn btn-add" onclick="addUser()">è¿½åŠ </button>
          </div>
          <div id="userList" class="master-list"></div>
        </div>
        
        <!-- ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ç™»éŒ² -->
        <div class="master-section">
          <h3>ğŸ“‚ ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ç™»éŒ²</h3>
          <div class="master-input-group">
            <input type="text" id="newServiceName" placeholder="ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†åã‚’å…¥åŠ›">
            <button class="btn btn-add" onclick="addService()">è¿½åŠ </button>
          </div>
          <div id="serviceList" class="master-list"></div>
        </div>
        
        <!-- è¨˜éŒ²è€…ç™»éŒ² -->
        <div class="master-section">
          <h3>âœï¸ è¨˜éŒ²è€…ç™»éŒ²</h3>
          <div class="master-input-group">
            <input type="text" id="newStaffName" placeholder="è¨˜éŒ²è€…åã‚’å…¥åŠ›">
            <button class="btn btn-add" onclick="addStaff()">è¿½åŠ </button>
          </div>
          <div id="staffList" class="master-list"></div>
        </div>
        
        <!-- æ”¯æ´å†…å®¹ç™»éŒ² -->
        <div class="master-section">
          <h3>ğŸ“ æ”¯æ´å†…å®¹ç™»éŒ²</h3>
          <div class="master-input-group">
            <input type="text" id="newSupportType" placeholder="æ”¯æ´å†…å®¹ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šãƒ¬ã‚¯ãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰">
            <button class="btn btn-add" onclick="addSupportType()">è¿½åŠ </button>
          </div>
          <div id="supportTypeList" class="master-list"></div>
        </div>
        
        <!-- æ§˜å­ãƒ»çŠ¶æ…‹ç™»éŒ² -->
        <div class="master-section">
          <h3>ğŸ˜Š æ§˜å­ãƒ»çŠ¶æ…‹ç™»éŒ²</h3>
          <div class="master-input-group">
            <input type="text" id="newCondition" placeholder="æ§˜å­ãƒ»çŠ¶æ…‹ã‚’å…¥åŠ›ï¼ˆä¾‹:å…ƒæ°—ï¼‰">
            <button class="btn btn-add" onclick="addCondition()">è¿½åŠ </button>
          </div>
          <div id="conditionList" class="master-list"></div>
        </div>
        
        <!-- æ”¯æ´å†…å®¹ã¨æ§˜å­çŠ¶æ…‹ã®é€£å‹•è¨­å®š -->
        <div class="master-section">
          <h3>ğŸ”— æ”¯æ´å†…å®¹ã¨æ§˜å­çŠ¶æ…‹ã®é€£å‹•è¨­å®š</h3>
          <div class="master-input-group">
            <select id="mappingSupportType">
              <option value="">æ”¯æ´å†…å®¹ã‚’é¸æŠ</option>
            </select>
            <select id="mappingCondition" multiple style="min-height: 150px;">
              <option value="">æ§˜å­ãƒ»çŠ¶æ…‹ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</option>
            </select>
            <button class="btn btn-save" onclick="saveConditionMapping()">ğŸ’¾ é€£å‹•è¨­å®šã‚’ä¿å­˜</button>
          </div>
          <div id="conditionMappingList" class="master-list"></div>
        </div>
        
        <!-- æ´»å‹•å ´æ‰€ç™»éŒ² -->
        <div class="master-section">
          <h3>ğŸ“ æ´»å‹•å ´æ‰€ç™»éŒ²</h3>
          <div class="master-input-group">
            <input type="text" id="newLocation" placeholder="æ´»å‹•å ´æ‰€ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šä½œæ¥­å®¤ï¼‰">
            <button class="btn btn-add" onclick="addLocation()">è¿½åŠ </button>
          </div>
          <div id="locationList" class="master-list"></div>
        </div>
        
        <!-- æ´»å‹•å†…å®¹ç™»éŒ² -->
        <div class="master-section">
          <h3>ğŸ¯ æ´»å‹•å†…å®¹ç™»éŒ²</h3>
          <div class="master-input-group">
            <input type="text" id="newActivityType" placeholder="æ´»å‹•å†…å®¹ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šè»½ä½œæ¥­ï¼‰">
            <button class="btn btn-add" onclick="addActivityType()">è¿½åŠ </button>
          </div>
          <div id="activityTypeList" class="master-list"></div>
        </div>
        
        <!-- ãƒ­ã‚°ã‚¤ãƒ³IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç† -->
        <div class="master-section" style="background: #fff3e0; border: 2px solid #ff9800;">
          <h3>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†</h3>
          <div class="sync-info" style="background: #ffe0b2;">
            <strong>âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</strong><br>
            åˆæœŸè¨­å®š:<br>
            ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ID: admin<br>
            ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: admin123<br>
            <br>
            <strong>å¿…ãšå¤‰æ›´ã—ã¦ãã ã•ã„ï¼</strong>
          </div>
          <div class="master-input-group" style="margin-top: 15px;">
            <input type="text" id="newLoginId" placeholder="æ–°ã—ã„ãƒ­ã‚°ã‚¤ãƒ³ID">
            <input type="password" id="newLoginPassword" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button class="btn btn-save" onclick="updateLoginCredentials()">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’æ›´æ–°</button>
          </div>
        </div>
      </div>
    </div>

    <!-- éŸ³å£°å…¥åŠ›ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div id="voiceIndicator" class="voice-indicator">
      <div class="voice-wave"></div>
      <div style="font-size: 20px; font-weight: bold; margin-bottom: 10px;">ğŸ¤ éŸ³å£°å…¥åŠ›ä¸­...</div>
      <div style="font-size: 16px;">è©±ã—ã¦ãã ã•ã„</div>
      <button class="btn btn-cancel" onclick="stopVoiceInput()" style="margin-top: 20px;">åœæ­¢</button>
    </div>

    <!-- å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="input-section">
      <h3>
        <span>âœï¸ è¨˜éŒ²å…¥åŠ›</span>
        <button class="btn btn-add" onclick="addInputRow()">â• è¨˜éŒ²è¿½åŠ </button>
      </h3>
      <div id="inputContainer">
        <!-- å…¥åŠ›è¡ŒãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
      </div>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ã‚¨ãƒªã‚¢ -->
    <div class="filter-box">
      <h3>ğŸ” çµã‚Šè¾¼ã¿æ¤œç´¢</h3>
      <div class="filter-row">
        <input type="month" id="filterMonth" placeholder="æœˆã§çµã‚Šè¾¼ã¿">
        <select id="filterService">
          <option value="">ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ï¼ˆå…¨ã¦ï¼‰</option>
        </select>
        <input type="text" id="filterUser" placeholder="åˆ©ç”¨è€…åã§çµã‚Šè¾¼ã¿">
        <button class="btn btn-add" onclick="applyFilter()">ğŸ” æ¤œç´¢</button>
        <button class="btn btn-cancel" onclick="resetFilter()">â™» ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="table-container">
      <h3 style="color: #2c5aa0; margin-top: 0;">ğŸ“Š è¨˜éŒ²ä¸€è¦§</h3>
      <table id="recordTable">
        <thead>
          <tr>
            <th>è¨˜éŒ²æ—¥</th>
            <th>ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†</th>
            <th>åˆ©ç”¨è€…å</th>
            <th>è¨˜éŒ²è€…å</th>
            <th>å†…å®¹</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
  // ãƒ­ã‚°ã‚¤ãƒ³ç®¡ç†
  let isLoggedIn = false;
  let currentLoginUser = '';
  
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±
  const DEFAULT_LOGIN = {
    id: 'admin',
    password: 'admin123'
  };
  
  // ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—
  function getLoginCredentials() {
    const saved = localStorage.getItem('loginCredentials');
    if (saved) {
      return JSON.parse(saved);
    }
    return DEFAULT_LOGIN;
  }
  
  // ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ä¿å­˜
  function saveLoginCredentials(id, password) {
    localStorage.setItem('loginCredentials', JSON.stringify({ id, password }));
  }
  
  // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
  function handleLogin(event) {
    event.preventDefault();
    
    const inputId = document.getElementById('loginId').value.trim();
    const inputPassword = document.getElementById('loginPassword').value;
    const credentials = getLoginCredentials();
    
    if (inputId === credentials.id && inputPassword === credentials.password) {
      isLoggedIn = true;
      currentLoginUser = inputId;
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ï¼ˆ24æ™‚é–“æœ‰åŠ¹ï¼‰
      const session = {
        user: inputId,
        timestamp: Date.now()
      };
      sessionStorage.setItem('userSession', JSON.stringify(session));
      
      showApp();
    } else {
      showError('ãƒ­ã‚°ã‚¤ãƒ³IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
    }
  }
  
  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
  function handleLogout() {
    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
      isLoggedIn = false;
      currentLoginUser = '';
      sessionStorage.removeItem('userSession');
      showLogin();
    }
  }
  
  // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  function showError(message) {
    const errorEl = document.getElementById('errorMessage');
    errorEl.textContent = message;
    errorEl.classList.add('show');
    
    setTimeout(() => {
      errorEl.classList.remove('show');
    }, 3000);
  }
  
  // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
  function showLogin() {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appScreen').classList.remove('active');
    document.getElementById('loginId').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginId').focus();
  }
  
  // ã‚¢ãƒ—ãƒªç”»é¢è¡¨ç¤º
  function showApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appScreen').classList.add('active');
    document.getElementById('currentUser').textContent = currentLoginUser;
  }
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
  function checkSession() {
    const session = sessionStorage.getItem('userSession');
    if (session) {
      const data = JSON.parse(session);
      const elapsed = Date.now() - data.timestamp;
      const TWENTY_FOUR_HOURS = 24 * 60 * 60 * 1000;
      
      if (elapsed < TWENTY_FOUR_HOURS) {
        isLoggedIn = true;
        currentLoginUser = data.user;
        showApp();
        return true;
      } else {
        sessionStorage.removeItem('userSession');
      }
    }
    showLogin();
    return false;
  }
  
  // ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±æ›´æ–°
  function updateLoginCredentials() {
    const newId = document.getElementById('newLoginId').value.trim();
    const newPassword = document.getElementById('newLoginPassword').value;
    
    if (!newId || !newPassword) {
      alert('ãƒ­ã‚°ã‚¤ãƒ³IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (newPassword.length < 6) {
      alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (confirm('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ\n\næ–°ã—ã„æƒ…å ±ã¯å¿˜ã‚Œãªã„ã‚ˆã†ã«ãƒ¡ãƒ¢ã—ã¦ãã ã•ã„ã€‚')) {
      saveLoginCredentials(newId, newPassword);
      document.getElementById('newLoginId').value = '';
      document.getElementById('newLoginPassword').value = '';
      alert('âœ“ ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ\n\næ¬¡å›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã‹ã‚‰æ–°ã—ã„æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
    }
  }
  
  // æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã‹ã‚‰ç¶™ç¶š...
  let records = [];
  let filtered = [];
  let rowIdCounter = 0;
  let supportCounterMap = {};
  let vitalCounterMap = {};
  
  // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
  let masterUsers = [];
  let masterServices = ["ç”Ÿæ´»ä»‹è­·", "å°±åŠ´ç¶™ç¶šAå‹", "å°±åŠ´ç¶™ç¶šBå‹", "å…¥æ‰€æ”¯æ´", "å±…å®…ä»‹è­·", "ãã®ä»–"];
  let masterStaff = [];
  let masterSupportTypes = ["é£Ÿäº‹æ”¯æ´", "æ’æ³„æ”¯æ´", "å…¥æµ´æ”¯æ´", "æ´»å‹•æ”¯æ´", "ç§»å‹•æ”¯æ´", "ä½œæ¥­æ”¯æ´", "å¥åº·ç®¡ç†", "ç›¸è«‡æ”¯æ´", "ãã®ä»–"];
  let masterConditions = ["è‰¯å¥½", "æ™®é€š", "ã‚„ã‚„ä¸èª¿", "ä¸èª¿", "è¦è¦³å¯Ÿ"];
  let masterLocations = ["ä½œæ¥­å®¤", "ãƒ›ãƒ¼ãƒ«", "é£Ÿå ‚", "å±‹å¤–", "ç›¸è«‡å®¤", "å±…å®¤", "ãã®ä»–"];
  let masterActivityTypes = ["è»½ä½œæ¥­", "æ¸…æƒ", "å‰µä½œæ´»å‹•", "ãƒ¬ã‚¯ãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³", "åœ’èŠ¸", "èª¿ç†", "é‹å‹•", "ãã®ä»–"];
  
  // æ”¯æ´å†…å®¹ã¨æ§˜å­çŠ¶æ…‹ã®é€£å‹•ãƒãƒƒãƒ”ãƒ³ã‚°
  let supportConditionMap = {
    "é£Ÿäº‹æ”¯æ´": ["å®Œé£Ÿ", "åŠåˆ†æ‘‚å–", "å°‘é‡æ‘‚å–", "æ‹’å¦", "ä»‹åŠ©å¿…è¦"],
    "æ’æ³„æ”¯æ´": ["è‡ªç«‹", "ä¸€éƒ¨ä»‹åŠ©", "å…¨ä»‹åŠ©", "å¤±ç¦ã‚ã‚Š", "å•é¡Œãªã—"],
    "å…¥æµ´æ”¯æ´": ["è‡ªç«‹", "ä¸€éƒ¨ä»‹åŠ©", "å…¨ä»‹åŠ©", "æ‹’å¦", "æ¸…æ½”ä¿æŒ"],
    "æ´»å‹•æ”¯æ´": ["ç©æ¥µçš„", "æ„æ¬²çš„", "æ¶ˆæ¥µçš„", "æ‹’å¦", "é›†ä¸­"],
    "ç§»å‹•æ”¯æ´": ["è‡ªç«‹", "è¦‹å®ˆã‚Š", "ä¸€éƒ¨ä»‹åŠ©", "å…¨ä»‹åŠ©", "å•é¡Œãªã—"],
    "ä½œæ¥­æ”¯æ´": ["é›†ä¸­", "æ„æ¬²çš„", "ç–²åŠ´", "ä¸­æ–­", "å®Œäº†"],
    "å¥åº·ç®¡ç†": ["è‰¯å¥½", "æ™®é€š", "ã‚„ã‚„ä¸èª¿", "ä¸èª¿", "è¦è¦³å¯Ÿ"],
    "ç›¸è«‡æ”¯æ´": ["å‚¾è´", "åŠ©è¨€", "æƒ…å ±æä¾›", "ç¶™ç¶šæ”¯æ´", "å®Œäº†"],
    "ãã®ä»–": ["è‰¯å¥½", "æ™®é€š", "ã‚„ã‚„ä¸èª¿", "ä¸èª¿", "è¦è¦³å¯Ÿ"]
  };
  
  // éŸ³å£°èªè­˜
  let recognition = null;
  let currentVoiceInput = null;
  
  // éŸ³å£°èªè­˜ã®åˆæœŸåŒ–
  function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.continuous = false;
      recognition.interimResults = false;
      
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        if (currentVoiceInput) {
          currentVoiceInput.value = transcript;
        }
        hideVoiceIndicator();
      };
      
      recognition.onerror = function(event) {
        console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
        hideVoiceIndicator();
        if (event.error !== 'no-speech' && event.error !== 'aborted') {
          alert('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ' + event.error + '\n\nChromeã¾ãŸã¯Safariãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚');
        }
      };
      
      recognition.onend = function() {
        hideVoiceIndicator();
      };
    }
  }
  
  // éŸ³å£°å…¥åŠ›é–‹å§‹
  function startVoiceInput(inputElement) {
    if (!recognition) {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\n\nChromeã€Safariã€Edgeã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
      return;
    }
    
    currentVoiceInput = inputElement;
    showVoiceIndicator();
    
    try {
      recognition.start();
    } catch (e) {
      console.error('éŸ³å£°èªè­˜é–‹å§‹ã‚¨ãƒ©ãƒ¼:', e);
      hideVoiceIndicator();
      setTimeout(() => {
        try {
          recognition.start();
        } catch (e2) {
          console.error('éŸ³å£°èªè­˜å†é–‹ã‚¨ãƒ©ãƒ¼:', e2);
        }
      }, 100);
    }
  }
  
  function stopVoiceInput() {
    if (recognition) {
      recognition.stop();
    }
    hideVoiceIndicator();
  }
  
  function showVoiceIndicator() {
    document.getElementById('voiceIndicator').classList.add('active');
  }
  
  function hideVoiceIndicator() {
    document.getElementById('voiceIndicator').classList.remove('active');
  }
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
  function loadMasterData() {
    const savedUsers = localStorage.getItem('masterUsers');
    const savedServices = localStorage.getItem('masterServices');
    const savedStaff = localStorage.getItem('masterStaff');
    const savedSupportTypes = localStorage.getItem('masterSupportTypes');
    const savedConditions = localStorage.getItem('masterConditions');
    const savedLocations = localStorage.getItem('masterLocations');
    const savedActivityTypes = localStorage.getItem('masterActivityTypes');
    const savedSupportConditionMap = localStorage.getItem('supportConditionMap');
    const savedRecords = localStorage.getItem('records');
    
    if (savedUsers) masterUsers = JSON.parse(savedUsers);
    if (savedServices) masterServices = JSON.parse(savedServices);
    if (savedStaff) masterStaff = JSON.parse(savedStaff);
    if (savedSupportTypes) masterSupportTypes = JSON.parse(savedSupportTypes);
    if (savedConditions) masterConditions = JSON.parse(savedConditions);
    if (savedLocations) masterLocations = JSON.parse(savedLocations);
    if (savedActivityTypes) masterActivityTypes = JSON.parse(savedActivityTypes);
    if (savedSupportConditionMap) supportConditionMap = JSON.parse(savedSupportConditionMap);
    if (savedRecords) {
      records = JSON.parse(savedRecords);
      filtered = [...records];
    }
  }
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
  function saveMasterData() {
    localStorage.setItem('masterUsers', JSON.stringify(masterUsers));
    localStorage.setItem('masterServices', JSON.stringify(masterServices));
    localStorage.setItem('masterStaff', JSON.stringify(masterStaff));
    localStorage.setItem('masterSupportTypes', JSON.stringify(masterSupportTypes));
    localStorage.setItem('masterConditions', JSON.stringify(masterConditions));
    localStorage.setItem('masterLocations', JSON.stringify(masterLocations));
    localStorage.setItem('masterActivityTypes', JSON.stringify(masterActivityTypes));
    localStorage.setItem('supportConditionMap', JSON.stringify(supportConditionMap));
  }
  
  function saveRecords() {
    localStorage.setItem('records', JSON.stringify(records));
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
  function openMasterModal() {
    document.getElementById('masterModal').style.display = 'block';
    renderMasterLists();
  }
  
  function closeMasterModal() {
    document.getElementById('masterModal').style.display = 'none';
    updateFilterOptions();
  }
  
  function openSyncModal() {
    document.getElementById('syncModal').style.display = 'block';
    const savedUrl = localStorage.getItem('sheetsApiUrl');
    if (savedUrl) {
      document.getElementById('sheetsApiUrl').value = savedUrl;
    }
  }
  
  function closeSyncModal() {
    document.getElementById('syncModal').style.display = 'none';
  }
  
  // åŒæœŸè¨­å®šä¿å­˜
  function saveSyncSettings() {
    const url = document.getElementById('sheetsApiUrl').value.trim();
    if (url) {
      localStorage.setItem('sheetsApiUrl', url);
      showSyncStatus('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', false);
    } else {
      alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
  }
  
  // ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  async function syncToCloud() {
    const apiUrl = localStorage.getItem('sheetsApiUrl');
    if (!apiUrl) {
      alert('å…ˆã«Google Sheets APIã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„');
      return;
    }
    
    showSyncStatus('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', false);
    
    try {
      const data = {
        records: records,
        masterUsers: masterUsers,
        masterServices: masterServices,
        masterStaff: masterStaff,
        masterSupportTypes: masterSupportTypes,
        masterConditions: masterConditions,
        masterLocations: masterLocations,
        masterActivityTypes: masterActivityTypes,
        supportConditionMap: supportConditionMap
      };
      
      const response = await fetch(apiUrl, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      });
      
      showSyncStatus('âœ“ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ã¾ã—ãŸ', false);
    } catch (error) {
      showSyncStatus('âœ— ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
    }
  }
  
  // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  async function syncFromCloud() {
    const apiUrl = localStorage.getItem('sheetsApiUrl');
    if (!apiUrl) {
      alert('å…ˆã«Google Sheets APIã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„');
      return;
    }
    
    showSyncStatus('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...', false);
    
    try {
      const response = await fetch(apiUrl + '?action=get');
      const data = await response.json();
      
      if (data.records) records = data.records;
      if (data.masterUsers) masterUsers = data.masterUsers;
      if (data.masterServices) masterServices = data.masterServices;
      if (data.masterStaff) masterStaff = data.masterStaff;
      if (data.masterSupportTypes) masterSupportTypes = data.masterSupportTypes;
      if (data.masterConditions) masterConditions = data.masterConditions;
      if (data.masterLocations) masterLocations = data.masterLocations;
      if (data.masterActivityTypes) masterActivityTypes = data.masterActivityTypes;
      if (data.supportConditionMap) supportConditionMap = data.supportConditionMap;
      
      saveMasterData();
      saveRecords();
      filtered = [...records];
      renderTable();
      updateFilterOptions();
      
      showSyncStatus('âœ“ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ã¾ã—ãŸ', false);
    } catch (error) {
      showSyncStatus('âœ— ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
    }
  }
  
  function showSyncStatus(message, isError) {
    const statusEl = document.getElementById('syncStatus');
    statusEl.textContent = message;
    statusEl.style.display = 'block';
    if (isError) {
      statusEl.classList.add('error');
    } else {
      statusEl.classList.remove('error');
    }
    
    setTimeout(() => {
      statusEl.style.display = 'none';
    }, 5000);
  }
  
  // åˆ©ç”¨è€…è¿½åŠ 
  function addUser() {
    const name = document.getElementById('newUserName').value.trim();
    const service = document.getElementById('newUserService').value;
    
    if (!name) {
      alert('åˆ©ç”¨è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    if (!service) {
      alert('ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterUsers.some(u => u.name === name && u.service === service)) {
      alert('ã“ã®åˆ©ç”¨è€…ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterUsers.push({name, service});
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newUserName').value = '';
    document.getElementById('newUserService').value = '';
  }
  
  function deleteUser(index) {
    if (confirm(`ã€Œ${masterUsers[index].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      masterUsers.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  function addService() {
    const name = document.getElementById('newServiceName').value.trim();
    
    if (!name) {
      alert('ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterServices.includes(name)) {
      alert('ã“ã®ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterServices.push(name);
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newServiceName').value = '';
  }
  
  function deleteService(index) {
    if (confirm(`ã€Œ${masterServices[index]}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      masterServices.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  function addStaff() {
    const name = document.getElementById('newStaffName').value.trim();
    
    if (!name) {
      alert('è¨˜éŒ²è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterStaff.includes(name)) {
      alert('ã“ã®è¨˜éŒ²è€…ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterStaff.push(name);
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newStaffName').value = '';
  }
  
  function deleteStaff(index) {
    if (confirm(`ã€Œ${masterStaff[index]}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      masterStaff.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  // æ”¯æ´å†…å®¹è¿½åŠ 
  function addSupportType() {
    const name = document.getElementById('newSupportType').value.trim();
    
    if (!name) {
      alert('æ”¯æ´å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterSupportTypes.includes(name)) {
      alert('ã“ã®æ”¯æ´å†…å®¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterSupportTypes.push(name);
    if (!supportConditionMap[name]) {
      supportConditionMap[name] = ["è‰¯å¥½", "æ™®é€š", "ã‚„ã‚„ä¸èª¿"];
    }
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newSupportType').value = '';
  }
  
  function deleteSupportType(index) {
    const supportType = masterSupportTypes[index];
    if (confirm(`ã€Œ${supportType}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      masterSupportTypes.splice(index, 1);
      delete supportConditionMap[supportType];
      saveMasterData();
      renderMasterLists();
    }
  }
  
  // æ§˜å­ãƒ»çŠ¶æ…‹è¿½åŠ 
  function addCondition() {
    const name = document.getElementById('newCondition').value.trim();
    
    if (!name) {
      alert('æ§˜å­ãƒ»çŠ¶æ…‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterConditions.includes(name)) {
      alert('ã“ã®æ§˜å­ãƒ»çŠ¶æ…‹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterConditions.push(name);
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newCondition').value = '';
  }
  
  function deleteCondition(index) {
    if (confirm(`ã€Œ${masterConditions[index]}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      masterConditions.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  // æ”¯æ´å†…å®¹ã¨æ§˜å­çŠ¶æ…‹ã®é€£å‹•è¨­å®šã‚’ä¿å­˜
  function saveConditionMapping() {
    const supportType = document.getElementById('mappingSupportType').value;
    const conditionSelect = document.getElementById('mappingCondition');
    const selectedConditions = Array.from(conditionSelect.selectedOptions).map(opt => opt.value);
    
    if (!supportType) {
      alert('æ”¯æ´å†…å®¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    if (selectedConditions.length === 0) {
      alert('å°‘ãªãã¨ã‚‚1ã¤ã®æ§˜å­ãƒ»çŠ¶æ…‹ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    supportConditionMap[supportType] = selectedConditions;
    saveMasterData();
    renderMasterLists();
    
    alert(`ã€Œ${supportType}ã€ã®æ§˜å­ãƒ»çŠ¶æ…‹ã‚’è¨­å®šã—ã¾ã—ãŸ`);
  }
  
  // æ´»å‹•å ´æ‰€è¿½åŠ 
  function addLocation() {
    const name = document.getElementById('newLocation').value.trim();
    
    if (!name) {
      alert('æ´»å‹•å ´æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterLocations.includes(name)) {
      alert('ã“ã®æ´»å‹•å ´æ‰€ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterLocations.push(name);
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newLocation').value = '';
  }
  
  function deleteLocation(index) {
    if (confirm(`ã€Œ${masterLocations[index]}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      masterLocations.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  // æ´»å‹•å†…å®¹è¿½åŠ 
  function addActivityType() {
    const name = document.getElementById('newActivityType').value.trim();
    
    if (!name) {
      alert('æ´»å‹•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterActivityTypes.includes(name)) {
      alert('ã“ã®æ´»å‹•å†…å®¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterActivityTypes.push(name);
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newActivityType').value = '';
  }
  
  function deleteActivityType(index) {
    if (confirm(`ã€Œ${masterActivityTypes[index]}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      masterActivityTypes.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  function renderMasterLists() {
    // ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†é¸æŠè‚¢ã‚’æ›´æ–°
    const newUserServiceEl = document.getElementById('newUserService');
    newUserServiceEl.innerHTML = '<option value="">ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã‚’é¸æŠ</option>';
    masterServices.forEach(service => {
      const option = document.createElement('option');
      option.value = service;
      option.textContent = service;
      newUserServiceEl.appendChild(option);
    });
    
    // åˆ©ç”¨è€…ãƒªã‚¹ãƒˆ
    const userListEl = document.getElementById('userList');
    userListEl.innerHTML = '';
    masterUsers.forEach((user, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${user.name}</div>
          <div class="master-item-service">
            <span class="service-badge badge-${user.service}">${user.service}</span>
          </div>
        </div>
        <button class="btn-delete" onclick="deleteUser(${index})">å‰Šé™¤</button>
      `;
      userListEl.appendChild(item);
    });
    
    // ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ãƒªã‚¹ãƒˆ
    const serviceListEl = document.getElementById('serviceList');
    serviceListEl.innerHTML = '';
    masterServices.forEach((service, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">
            <span class="service-badge badge-${service}">${service}</span>
          </div>
        </div>
        <button class="btn-delete" onclick="deleteService(${index})">å‰Šé™¤</button>
      `;
      serviceListEl.appendChild(item);
    });
    
    // è¨˜éŒ²è€…ãƒªã‚¹ãƒˆ
    const staffListEl = document.getElementById('staffList');
    staffListEl.innerHTML = '';
    masterStaff.forEach((staff, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${staff}</div>
        </div>
        <button class="btn-delete" onclick="deleteStaff(${index})">å‰Šé™¤</button>
      `;
      staffListEl.appendChild(item);
    });
    
    // æ”¯æ´å†…å®¹ãƒªã‚¹ãƒˆ
    const supportTypeListEl = document.getElementById('supportTypeList');
    supportTypeListEl.innerHTML = '';
    masterSupportTypes.forEach((type, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${type}</div>
        </div>
        <button class="btn-delete" onclick="deleteSupportType(${index})">å‰Šé™¤</button>
      `;
      supportTypeListEl.appendChild(item);
    });
    
    // æ§˜å­ãƒ»çŠ¶æ…‹ãƒªã‚¹ãƒˆ
    const conditionListEl = document.getElementById('conditionList');
    conditionListEl.innerHTML = '';
    masterConditions.forEach((condition, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${condition}</div>
        </div>
        <button class="btn-delete" onclick="deleteCondition(${index})">å‰Šé™¤</button>
      `;
      conditionListEl.appendChild(item);
    });
    
    // é€£å‹•è¨­å®šç”¨ã®æ”¯æ´å†…å®¹é¸æŠè‚¢
    const mappingSupportTypeEl = document.getElementById('mappingSupportType');
    mappingSupportTypeEl.innerHTML = '<option value="">æ”¯æ´å†…å®¹ã‚’é¸æŠ</option>';
    masterSupportTypes.forEach(type => {
      const option = document.createElement('option');
      option.value = type;
      option.textContent = type;
      mappingSupportTypeEl.appendChild(option);
    });
    
    // é€£å‹•è¨­å®šç”¨ã®æ§˜å­ãƒ»çŠ¶æ…‹é¸æŠè‚¢
    const mappingConditionEl = document.getElementById('mappingCondition');
    mappingConditionEl.innerHTML = '';
    masterConditions.forEach(cond => {
      const option = document.createElement('option');
      option.value = cond;
      option.textContent = cond;
      mappingConditionEl.appendChild(option);
    });
    
    // é€£å‹•ãƒãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤º
    const conditionMappingListEl = document.getElementById('conditionMappingList');
    conditionMappingListEl.innerHTML = '';
    Object.keys(supportConditionMap).forEach(supportType => {
      const conditions = supportConditionMap[supportType];
      const item = document.createElement('div');
      item.className = 'master-item';
      item.style.flexDirection = 'column';
      item.style.alignItems = 'flex-start';
      
      let conditionChips = '';
      conditions.forEach(cond => {
        conditionChips += `<span class="condition-chip">${cond}</span>`;
      });
      
      item.innerHTML = `
        <div style="width: 100%;">
          <div class="master-item-name" style="margin-bottom: 8px;">ğŸ“ ${supportType}</div>
          <div class="master-item-mapping">
            ${conditionChips}
          </div>
        </div>
      `;
      conditionMappingListEl.appendChild(item);
    });
    
    // æ´»å‹•å ´æ‰€ãƒªã‚¹ãƒˆ
    const locationListEl = document.getElementById('locationList');
    locationListEl.innerHTML = '';
    masterLocations.forEach((location, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${location}</div>
        </div>
        <button class="btn-delete" onclick="deleteLocation(${index})">å‰Šé™¤</button>
      `;
      locationListEl.appendChild(item);
    });
    
    // æ´»å‹•å†…å®¹ãƒªã‚¹ãƒˆ
    const activityTypeListEl = document.getElementById('activityTypeList');
    activityTypeListEl.innerHTML = '';
    masterActivityTypes.forEach((type, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${type}</div>
        </div>
        <button class="btn-delete" onclick="deleteActivityType(${index})">å‰Šé™¤</button>
      `;
      activityTypeListEl.appendChild(item);
    });
  }
  
  function updateUserOptions(selectElement, serviceValue) {
    const row = selectElement.closest('.basic-info-row');
    if (!row) return;
    
    const userSelect = row.querySelector('.row-user');
    if (!userSelect) return;
    
    userSelect.innerHTML = '<option value="">åˆ©ç”¨è€…ã‚’é¸æŠ</option>';
    
    if (serviceValue) {
      const filteredUsers = masterUsers.filter(u => u.service === serviceValue);
      filteredUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = user.name;
        option.textContent = user.name;
        userSelect.appendChild(option);
      });
    }
  }
  
  // æ”¯æ´å†…å®¹é¸æŠæ™‚ã«æ§˜å­çŠ¶æ…‹ã‚’é€£å‹•æ›´æ–°
  function updateConditionOptions(supportTypeSelect) {
    const supportType = supportTypeSelect.value;
    const row = supportTypeSelect.closest('.support-content-row');
    if (!row) return;
    
    const condSelects = row.querySelectorAll('select[class*="row-cond-"]');
    condSelects.forEach(condSelect => {
      const currentValue = condSelect.value;
      condSelect.innerHTML = '<option value="">é¸æŠ</option>';
      
      if (supportType && supportConditionMap[supportType]) {
        supportConditionMap[supportType].forEach(cond => {
          const option = document.createElement('option');
          option.value = cond;
          option.textContent = cond;
          condSelect.appendChild(option);
        });
        if (supportConditionMap[supportType].includes(currentValue)) {
          condSelect.value = currentValue;
        }
      } else {
        masterConditions.forEach(cond => {
          const option = document.createElement('option');
          option.value = cond;
          option.textContent = cond;
          condSelect.appendChild(option);
        });
        condSelect.value = currentValue;
      }
    });
  }
  
  // å…¥åŠ›ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ
  function toggleInputType(rowId) {
    const row = document.getElementById(`input-row-${rowId}`);
    if (!row) return;
    
    const supportArea = row.querySelector('.support-input-area');
    const vitalArea = row.querySelector('.vital-input-area');
    const toggleBtn = row.querySelector('.btn-toggle');
    
    if (supportArea.classList.contains('active')) {
      supportArea.classList.remove('active');
      vitalArea.classList.add('active');
      toggleBtn.textContent = 'ğŸ“ æ”¯æ´å†…å®¹å…¥åŠ›ã¸åˆ‡æ›¿';
      toggleBtn.classList.add('active');
    } else {
      vitalArea.classList.remove('active');
      supportArea.classList.add('active');
      toggleBtn.textContent = 'ğŸ¥ ãƒã‚¤ã‚¿ãƒ«å…¥åŠ›ã¸åˆ‡æ›¿';
      toggleBtn.classList.remove('active');
    }
  }
  
  // æ”¯æ´å†…å®¹ã‚’ä½œæˆ
  function createSupportContent(rowId, supportIndex) {
    let typeOptions = '<option value="">é¸æŠ</option>';
    masterSupportTypes.forEach(type => {
      typeOptions += `<option value="${type}">${type}</option>`;
    });
    
    let condOptions = '<option value="">é¸æŠ</option>';
    masterConditions.forEach(cond => {
      condOptions += `<option value="${cond}">${cond}</option>`;
    });
    
    let locationOptions = '<option value="">é¸æŠ</option>';
    masterLocations.forEach(location => {
      locationOptions += `<option value="${location}">${location}</option>`;
    });
    
    let activityOptions = '<option value="">é¸æŠ</option>';
    masterActivityTypes.forEach(activity => {
      activityOptions += `<option value="${activity}">${activity}</option>`;
    });
    
    const supportDiv = document.createElement('div');
    supportDiv.className = 'support-content-row';
    supportDiv.id = `support-${rowId}-${supportIndex}`;
    
    supportDiv.innerHTML = `
      <div class="input-field">
        <label>
          ${supportIndex === 1 ? '<span class="support-number">æ”¯æ´' + supportIndex + '</span> ' : ''}æ”¯æ´å†…å®¹${supportIndex === 1 ? '<span class="required">*</span>' : ''}
        </label>
        <select class="row-type-${supportIndex}" ${supportIndex === 1 ? 'required' : ''} onchange="updateConditionOptions(this)">
          ${typeOptions}
        </select>
      </div>
      
      <div class="input-field">
        <label>æ™‚é–“</label>
        <div class="input-field-time">
          <input type="time" class="row-start-time-${supportIndex}">
          <span>ã€œ</span>
          <input type="time" class="row-end-time-${supportIndex}">
        </div>
      </div>
      
      <div class="input-field">
        <label>æ§˜å­</label>
        <select class="row-cond-${supportIndex}">
          ${condOptions}
        </select>
      </div>
      
      <div class="input-field">
        <label>å ´æ‰€</label>
        <select class="row-location-${supportIndex}">
          ${locationOptions}
        </select>
      </div>
      
      <div class="input-field">
        <label>æ´»å‹•</label>
        <select class="row-activity-${supportIndex}">
          ${activityOptions}
        </select>
      </div>
      
      <div class="input-field">
        <label>
          è©³ç´°
          <button type="button" class="btn-voice" onclick="startVoiceInput(this.closest('.input-field').querySelector('textarea'))" title="éŸ³å£°">ğŸ¤</button>
        </label>
        <textarea class="row-detail-${supportIndex}" placeholder="è©³ç´°"></textarea>
      </div>
      
      <div class="input-field">
        <label>
          ç‰¹è¨˜
          <button type="button" class="btn-voice" onclick="startVoiceInput(this.closest('.input-field').querySelector('textarea'))" title="éŸ³å£°">ğŸ¤</button>
        </label>
        <textarea class="row-note-${supportIndex}" placeholder="ç‰¹è¨˜"></textarea>
      </div>
      
      ${supportIndex > 1 ? `
      <div class="support-actions">
        <button type="button" class="btn btn-remove" onclick="removeSupportContent(${rowId}, ${supportIndex})">âœ• å‰Šé™¤</button>
      </div>
      ` : ''}
    `;
    
    return supportDiv;
  }
  
  // æ”¯æ´å†…å®¹ã‚’è¿½åŠ 
  function addSupportContent(rowId) {
    const row = document.getElementById(`input-row-${rowId}`);
    if (!row) return;
    
    const supportSection = row.querySelector('.support-content-section');
    if (!supportSection) return;
    
    const currentCount = supportCounterMap[rowId] || 1;
    const newIndex = currentCount + 1;
    
    const newSupport = createSupportContent(rowId, newIndex);
    
    const addButton = supportSection.querySelector('.support-add-button');
    supportSection.insertBefore(newSupport, addButton);
    
    supportCounterMap[rowId] = newIndex;
    
    setTimeout(() => {
      newSupport.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
  }
  
  // æ”¯æ´å†…å®¹ã‚’å‰Šé™¤
  function removeSupportContent(rowId, supportIndex) {
    if (!confirm('ã“ã®æ”¯æ´å†…å®¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }
    
    const supportDiv = document.getElementById(`support-${rowId}-${supportIndex}`);
    if (supportDiv) {
      supportDiv.remove();
    }
  }
  
  // ãƒã‚¤ã‚¿ãƒ«æ¸¬å®šã‚’ä½œæˆ
  function createVitalEntry(rowId, vitalIndex) {
    const vitalDiv = document.createElement('div');
    vitalDiv.className = 'vital-entry';
    vitalDiv.id = `vital-${rowId}-${vitalIndex}`;
    
    vitalDiv.innerHTML = `
      <div class="vital-header">
        <span class="vital-number">æ¸¬å®š${vitalIndex}</span>
        <div class="vital-time">
          <label style="margin: 0;">æ¸¬å®šæ™‚åˆ»:</label>
          <input type="time" class="row-vital-time-${vitalIndex}">
        </div>
      </div>
      
      <div class="vital-grid">
        <div class="vital-field">
          <label>ä½“æ¸© (â„ƒ)</label>
          <input type="number" step="0.1" class="row-vital-temp-${vitalIndex}" placeholder="36.5">
        </div>
        <div class="vital-field">
          <label>è¡€åœ§ (ä¸Š)</label>
          <input type="number" class="row-vital-bp-sys-${vitalIndex}" placeholder="120">
        </div>
        <div class="vital-field">
          <label>è¡€åœ§ (ä¸‹)</label>
          <input type="number" class="row-vital-bp-dia-${vitalIndex}" placeholder="80">
        </div>
        <div class="vital-field">
          <label>è„ˆæ‹ (å›/åˆ†)</label>
          <input type="number" class="row-vital-pulse-${vitalIndex}" placeholder="70">
        </div>
        <div class="vital-field">
          <label>SpO2 (%)</label>
          <input type="number" class="row-vital-spo2-${vitalIndex}" placeholder="98">
        </div>
        <div class="vital-field">
          <label>å‘¼å¸æ•° (å›/åˆ†)</label>
          <input type="number" class="row-vital-resp-${vitalIndex}" placeholder="16">
        </div>
      </div>
      
      <div class="input-field" style="margin-top: 12px;">
        <label>
          ãƒã‚¤ã‚¿ãƒ«ç‰¹è¨˜äº‹é …
          <button type="button" class="btn-voice" onclick="startVoiceInput(this.closest('.input-field').querySelector('textarea'))" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
        </label>
        <textarea class="row-vital-note-${vitalIndex}" placeholder="ãƒã‚¤ã‚¿ãƒ«ã«é–¢ã™ã‚‹ç‰¹è¨˜äº‹é …"></textarea>
      </div>
      
      ${vitalIndex > 1 ? `
      <div class="support-actions">
        <button type="button" class="btn btn-remove" onclick="removeVitalEntry(${rowId}, ${vitalIndex})">âœ• ã“ã®æ¸¬å®šã‚’å‰Šé™¤</button>
      </div>
      ` : ''}
    `;
    
    return vitalDiv;
  }
  
  // ãƒã‚¤ã‚¿ãƒ«æ¸¬å®šã‚’è¿½åŠ 
  function addVitalEntry(rowId) {
    const row = document.getElementById(`input-row-${rowId}`);
    if (!row) return;
    
    const vitalSection = row.querySelector('.vital-section');
    if (!vitalSection) return;
    
    const currentCount = vitalCounterMap[rowId] || 1;
    const newIndex = currentCount + 1;
    
    const newVital = createVitalEntry(rowId, newIndex);
    
    const addButton = vitalSection.querySelector('.vital-add-button');
    vitalSection.insertBefore(newVital, addButton);
    
    vitalCounterMap[rowId] = newIndex;
    
    setTimeout(() => {
      newVital.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
  }
  
  // ãƒã‚¤ã‚¿ãƒ«æ¸¬å®šã‚’å‰Šé™¤
  function removeVitalEntry(rowId, vitalIndex) {
    if (!confirm('ã“ã®æ¸¬å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }
    
    const vitalDiv = document.getElementById(`vital-${rowId}-${vitalIndex}`);
    if (vitalDiv) {
      vitalDiv.remove();
    }
  }
  
  function createInputRow() {
    const rowId = ++rowIdCounter;
    const today = new Date().toISOString().split('T')[0];
    
    supportCounterMap[rowId] = 1;
    vitalCounterMap[rowId] = 1;
    
    const row = document.createElement('div');
    row.className = 'input-row';
    row.id = `input-row-${rowId}`;
    
    let serviceOptions = '<option value="">é¸æŠ</option>';
    masterServices.forEach(service => {
      serviceOptions += `<option value="${service}">${service}</option>`;
    });
    
    let staffOptions = '<option value="">é¸æŠ</option>';
    masterStaff.forEach(staff => {
      staffOptions += `<option value="${staff}">${staff}</option>`;
    });
    
    row.innerHTML = `
      <div class="basic-info-row">
        <div class="input-field">
          <label>è¨˜éŒ²æ—¥ <span class="required">*</span></label>
          <input type="date" class="row-date" value="${today}" required>
        </div>
        
        <div class="input-field">
          <label>ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ† <span class="required">*</span></label>
          <select class="row-service" required onchange="updateUserOptions(this, this.value)">
            ${serviceOptions}
          </select>
        </div>
        
        <div class="input-field">
          <label>åˆ©ç”¨è€…å <span class="required">*</span></label>
          <select class="row-user" required>
            <option value="">åˆ©ç”¨è€…ã‚’é¸æŠ</option>
          </select>
        </div>
        
        <div class="input-field">
          <label>è¨˜éŒ²è€…å <span class="required">*</span></label>
          <select class="row-staff" required>
            ${staffOptions}
          </select>
        </div>
      </div>
      
      <button type="button" class="btn btn-toggle" onclick="toggleInputType(${rowId})">ğŸ¥ ãƒã‚¤ã‚¿ãƒ«å…¥åŠ›ã¸åˆ‡æ›¿</button>
      
      <!-- æ”¯æ´å†…å®¹å…¥åŠ›ã‚¨ãƒªã‚¢ -->
      <div class="support-input-area active">
        <div class="support-content-section">
          <div class="support-label">
            <span>ğŸ“ æ”¯æ´å†…å®¹</span>
            <button type="button" class="btn btn-add" onclick="addSupportContent(${rowId})">â• æ”¯æ´å†…å®¹è¿½åŠ </button>
          </div>
          <div class="support-add-button"></div>
        </div>
      </div>
      
      <!-- ãƒã‚¤ã‚¿ãƒ«å…¥åŠ›ã‚¨ãƒªã‚¢ -->
      <div class="vital-input-area">
        <div class="vital-section">
          <div class="support-label">
            <span>ğŸ¥ ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</span>
            <button type="button" class="btn btn-add" onclick="addVitalEntry(${rowId})">â• æ¸¬å®šè¿½åŠ </button>
          </div>
          <div class="vital-add-button"></div>
        </div>
      </div>
      
      <div class="row-actions">
        <button type="button" class="btn btn-save" onclick="saveRow(${rowId})">âœ“ ä¿å­˜</button>
        <button type="button" class="btn btn-cancel" onclick="removeRow(${rowId})">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    `;
    
    const supportSection = row.querySelector('.support-content-section');
    const firstSupport = createSupportContent(rowId, 1);
    const supportAddButton = supportSection.querySelector('.support-add-button');
    supportSection.insertBefore(firstSupport, supportAddButton);
    
    const vitalSection = row.querySelector('.vital-section');
    const firstVital = createVitalEntry(rowId, 1);
    const vitalAddButton = vitalSection.querySelector('.vital-add-button');
    vitalSection.insertBefore(firstVital, vitalAddButton);
    
    return row;
  }

  function addInputRow() {
    const container = document.getElementById('inputContainer');
    const newRow = createInputRow();
    container.appendChild(newRow);
    newRow.classList.add('active');
    
    setTimeout(() => {
      newRow.scrollIntoView({ behavior: 'smooth', block: 'start' });
      const firstInput = newRow.querySelector('.row-date');
      if (firstInput) firstInput.focus();
    }, 100);
  }

  function removeRow(rowId) {
    const row = document.getElementById(`input-row-${rowId}`);
    if (row) {
      row.remove();
      delete supportCounterMap[rowId];
      delete vitalCounterMap[rowId];
    }
  }

  function saveRow(rowId) {
    const row = document.getElementById(`input-row-${rowId}`);
    if (!row) return;
    
    const date = row.querySelector('.row-date').value;
    const service = row.querySelector('.row-service').value;
    const user = row.querySelector('.row-user').value;
    const staff = row.querySelector('.row-staff').value;
    
    if (!date || !service || !user || !staff) {
      alert('å¿…é ˆé …ç›®ï¼ˆè¨˜éŒ²æ—¥ã€ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã€åˆ©ç”¨è€…åã€è¨˜éŒ²è€…åï¼‰ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    const supportArea = row.querySelector('.support-input-area');
    const vitalArea = row.querySelector('.vital-input-area');
    
    let record = { 
      date, 
      service, 
      user, 
      staff 
    };
    
    if (supportArea.classList.contains('active')) {
      const type1 = row.querySelector('.row-type-1').value;
      if (!type1) {
        alert('æ”¯æ´å†…å®¹1ã¯å¿…é ˆã§ã™');
        return;
      }
      
      const supportContents = [];
      const maxSupport = supportCounterMap[rowId] || 1;
      
      for (let i = 1; i <= maxSupport; i++) {
        const typeEl = row.querySelector(`.row-type-${i}`);
        if (!typeEl) continue;
        
        const type = typeEl.value;
        if (type) {
          const startTime = row.querySelector(`.row-start-time-${i}`)?.value || '';
          const endTime = row.querySelector(`.row-end-time-${i}`)?.value || '';
          const cond = row.querySelector(`.row-cond-${i}`)?.value || '';
          const location = row.querySelector(`.row-location-${i}`)?.value || '';
          const activity = row.querySelector(`.row-activity-${i}`)?.value || '';
          const detail = row.querySelector(`.row-detail-${i}`)?.value.trim() || '';
          const note = row.querySelector(`.row-note-${i}`)?.value.trim() || '';
          
          let timeRange = '';
          if (startTime && endTime) {
            timeRange = `${startTime}ã€œ${endTime}`;
          } else if (startTime) {
            timeRange = `${startTime}ã€œ`;
          } else if (endTime) {
            timeRange = `ã€œ${endTime}`;
          }
          
          supportContents.push({
            type,
            timeRange,
            cond,
            location,
            activity,
            detail,
            note
          });
        }
      }
      
      if (supportContents.length === 0) {
        alert('å°‘ãªãã¨ã‚‚1ã¤ã®æ”¯æ´å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      record.recordType = 'support';
      record.supportContents = supportContents;
      
      alert(`âœ“ æ”¯æ´è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ï¼ˆæ”¯æ´å†…å®¹: ${supportContents.length}ä»¶ï¼‰`);
    }
    else if (vitalArea.classList.contains('active')) {
      const vitalMeasurements = [];
      const maxVital = vitalCounterMap[rowId] || 1;
      
      for (let i = 1; i <= maxVital; i++) {
        const timeEl = row.querySelector(`.row-vital-time-${i}`);
        if (!timeEl) continue;
        
        const time = timeEl.value || '';
        const temp = row.querySelector(`.row-vital-temp-${i}`)?.value || '';
        const bpSys = row.querySelector(`.row-vital-bp-sys-${i}`)?.value || '';
        const bpDia = row.querySelector(`.row-vital-bp-dia-${i}`)?.value || '';
        const pulse = row.querySelector(`.row-vital-pulse-${i}`)?.value || '';
        const spo2 = row.querySelector(`.row-vital-spo2-${i}`)?.value || '';
        const resp = row.querySelector(`.row-vital-resp-${i}`)?.value || '';
        const note = row.querySelector(`.row-vital-note-${i}`)?.value.trim() || '';
        
        if (temp || bpSys || bpDia || pulse || spo2 || resp) {
          vitalMeasurements.push({
            time,
            temp,
            bpSys,
            bpDia,
            pulse,
            spo2,
            resp,
            note
          });
        }
      }
      
      if (vitalMeasurements.length === 0) {
        alert('å°‘ãªãã¨ã‚‚1ã¤ã®ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      record.recordType = 'vital';
      record.vitalMeasurements = vitalMeasurements;
      
      alert(`âœ“ ãƒã‚¤ã‚¿ãƒ«è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ï¼ˆæ¸¬å®šå›æ•°: ${vitalMeasurements.length}å›ï¼‰`);
    }
    
    records.push(record);
    saveRecords();
    
    filtered = [...records];
    renderTable();
    removeRow(rowId);
  }

  function renderTable() {
    const tbody = document.querySelector('#recordTable tbody');
    tbody.innerHTML = '';
    
    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #999;">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    
    const sorted = [...filtered].sort((a, b) => b.date.localeCompare(a.date));
    
    sorted.forEach(r => {
      const tr = document.createElement('tr');
      
      let contentHtml = '';
      
      if (r.recordType === 'support') {
        r.supportContents.forEach((s, idx) => {
          if (idx > 0) contentHtml += '<hr style="margin: 8px 0; border: none; border-top: 1px solid #ddd;">';
          contentHtml += '<div style="margin-bottom: 5px;">';
          contentHtml += `<strong>ã€${idx + 1}ã€‘${s.type}</strong><br>`;
          if (s.timeRange) contentHtml += `â° ${s.timeRange}<br>`;
          if (s.cond) contentHtml += `ğŸ˜Š ${s.cond}<br>`;
          if (s.location) contentHtml += `ğŸ“ ${s.location}ã€€`;
          if (s.activity) contentHtml += `ğŸ¯ ${s.activity}<br>`;
          if (s.detail) contentHtml += `ğŸ“„ ${s.detail}<br>`;
          if (s.note) contentHtml += `ğŸ“Œ ${s.note}`;
          contentHtml += '</div>';
        });
      }
      else if (r.recordType === 'vital') {
        contentHtml += '<div style="background: #ffe0e0; padding: 8px; border-radius: 4px;"><strong>ğŸ¥ ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</strong>';
        r.vitalMeasurements.forEach((v, idx) => {
          if (idx > 0) contentHtml += '<hr style="margin: 8px 0; border: none; border-top: 1px solid #ddd;">';
          contentHtml += '<div style="margin-top: 6px;">';
          if (v.time) contentHtml += `<strong>â° ${v.time}</strong><br>`;
          if (v.temp) contentHtml += `ä½“æ¸©: ${v.temp}â„ƒã€€`;
          if (v.bpSys && v.bpDia) contentHtml += `è¡€åœ§: ${v.bpSys}/${v.bpDia}mmHgã€€`;
          if (v.pulse) contentHtml += `è„ˆæ‹: ${v.pulse}å›/åˆ†ã€€`;
          if (v.spo2) contentHtml += `SpO2: ${v.spo2}%ã€€`;
          if (v.resp) contentHtml += `å‘¼å¸: ${v.resp}å›/åˆ†ã€€`;
          if (v.note) contentHtml += `<br>ğŸ“Œ ${v.note}`;
          contentHtml += '</div>';
        });
        contentHtml += '</div>';
      }
      
      tr.innerHTML = `
        <td>${r.date}</td>
        <td><span class="service-badge badge-${r.service}">${r.service}</span></td>
        <td>${r.user}</td>
        <td>${r.staff}</td>
        <td style="min-width: 300px;">${contentHtml}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function updateFilterOptions() {
    const filterServiceEl = document.getElementById('filterService');
    filterServiceEl.innerHTML = '<option value="">ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ï¼ˆå…¨ã¦ï¼‰</option>';
    masterServices.forEach(service => {
      const option = document.createElement('option');
      option.value = service;
      option.textContent = service;
      filterServiceEl.appendChild(option);
    });
  }

  function applyFilter() {
    const month = document.getElementById('filterMonth').value;
    const service = document.getElementById('filterService').value;
    const user = document.getElementById('filterUser').value.trim().toLowerCase();
    
    filtered = records.filter(r => {
      if (month && !r.date.startsWith(month)) return false;
      if (service && r.service !== service) return false;
      if (user && !r.user.toLowerCase().includes(user)) return false;
      return true;
    });
    
    renderTable();
  }

  function resetFilter() {
    document.getElementById('filterMonth').value = '';
    document.getElementById('filterService').value = '';
    document.getElementById('filterUser').value = '';
    filtered = [...records];
    renderTable();
  }

  function exportExcel() {
    if (filtered.length === 0) {
      alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    
    const supportData = [['è¨˜éŒ²æ—¥', 'ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†', 'åˆ©ç”¨è€…å', 'è¨˜éŒ²è€…å', 'æ”¯æ´å†…å®¹', 'æ™‚é–“', 'æ§˜å­ãƒ»çŠ¶æ…‹', 'æ´»å‹•å ´æ‰€', 'æ´»å‹•å†…å®¹', 'æ”¯æ´ã®è©³ç´°', 'ç‰¹è¨˜äº‹é …']];
    
    filtered.forEach(r => {
      if (r.recordType === 'support') {
        r.supportContents.forEach(s => {
          supportData.push([
            r.date,
            r.service,
            r.user,
            r.staff,
            s.type,
            s.timeRange,
            s.cond,
            s.location,
            s.activity,
            s.detail,
            s.note
          ]);
        });
      }
    });
    
    const vitalData = [['è¨˜éŒ²æ—¥', 'ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†', 'åˆ©ç”¨è€…å', 'è¨˜éŒ²è€…å', 'æ¸¬å®šæ™‚åˆ»', 'ä½“æ¸©', 'è¡€åœ§(ä¸Š)', 'è¡€åœ§(ä¸‹)', 'è„ˆæ‹', 'SpO2', 'å‘¼å¸æ•°', 'ç‰¹è¨˜äº‹é …']];
    
    filtered.forEach(r => {
      if (r.recordType === 'vital') {
        r.vitalMeasurements.forEach(v => {
          vitalData.push([
            r.date,
            r.service,
            r.user,
            r.staff,
            v.time,
            v.temp,
            v.bpSys,
            v.bpDia,
            v.pulse,
            v.spo2,
            v.resp,
            v.note
          ]);
        });
      }
    });
    
    const masterData = [['ç¨®åˆ¥', 'ãƒ‡ãƒ¼ã‚¿']];
    
    masterData.push(['åˆ©ç”¨è€…', '']);
    masterUsers.forEach(u => {
      masterData.push(['', `${u.name}ï¼ˆ${u.service}ï¼‰`]);
    });
    
    masterData.push(['ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†', '']);
    masterServices.forEach(s => {
      masterData.push(['', s]);
    });
    
    masterData.push(['è¨˜éŒ²è€…', '']);
    masterStaff.forEach(s => {
      masterData.push(['', s]);
    });
    
    const wb = XLSX.utils.book_new();
    const wsSup = XLSX.utils.aoa_to_sheet(supportData);
    const wsVit = XLSX.utils.aoa_to_sheet(vitalData);
    const wsMas = XLSX.utils.aoa_to_sheet(masterData);
    
    XLSX.utils.book_append_sheet(wb, wsSup, 'æ”¯æ´è¨˜éŒ²');
    XLSX.utils.book_append_sheet(wb, wsVit, 'ãƒã‚¤ã‚¿ãƒ«è¨˜éŒ²');
    XLSX.utils.book_append_sheet(wb, wsMas, 'ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿');
    
    const today = new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, `æ”¯æ´è¨˜éŒ²_${today}.xlsx`);
    
    alert('âœ“ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
  }

  function clearAll() {
    if (!confirm('ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nâ€»ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“')) {
      return;
    }
    
    records = [];
    filtered = [];
    saveRecords();
    renderTable();
    alert('âœ“ ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
  document.addEventListener('DOMContentLoaded', () => {
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
    checkSession();
    
    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    loadMasterData();
    renderTable();
    updateFilterOptions();
    initSpeechRecognition();
  });

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  window.onclick = function(event) {
    const masterModal = document.getElementById('masterModal');
    const syncModal = document.getElementById('syncModal');
    
    if (event.target === masterModal) {
      closeMasterModal();
    }
    if (event.target === syncModal) {
      closeSyncModal();
    }
  }
</script>
</body>
</html>